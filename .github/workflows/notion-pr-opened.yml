name: Create Notion Task on PR Open

on:
  pull_request:
    types: [opened, reopened]

jobs:
  create-notion-task:
    runs-on: ubuntu-latest
    steps:
      - name: Create Notion Task
        uses: actions/github-script@v7
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const prTitle = context.payload.pull_request.title;
            const prUrl = context.payload.pull_request.html_url;
            const prAuthor = context.payload.pull_request.user.login;

            // Make API call to Notion
            const notionApiKey = process.env.NOTION_API_KEY;
            const notionDatabaseId = process.env.NOTION_DATABASE_ID;

            if (!notionApiKey || !notionDatabaseId) {
              console.log('‚ö†Ô∏è  Notion API credentials not configured. Skipping Notion task creation.');
              console.log('To enable Notion integration, add NOTION_API_KEY and NOTION_DATABASE_ID secrets to your repository.');
              return;
            }

            const notionData = {
              parent: { database_id: notionDatabaseId },
              properties: {
                Name: {
                  title: [
                    {
                      text: {
                        content: `PR #${prNumber}: ${prTitle}`
                      }
                    }
                  ]
                },
                Status: {
                  status: {
                    name: "In Progress"
                  }
                },
                URL: {
                  url: prUrl
                },
                Author: {
                  rich_text: [
                    {
                      text: {
                        content: prAuthor
                      }
                    }
                  ]
                },
                "PR Number": {
                  number: prNumber
                }
              }
            };

            try {
              const response = await fetch('https://api.notion.com/v1/pages', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${notionApiKey}`,
                  'Content-Type': 'application/json',
                  'Notion-Version': '2022-06-28'
                },
                body: JSON.stringify(notionData)
              });

              if (!response.ok) {
                const error = await response.text();
                throw new Error(`Notion API error: ${response.status} - ${error}`);
              }

              const result = await response.json();
              console.log('‚úÖ Successfully created Notion task:', result.id);

              // Store the Notion page ID in a comment for later reference
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `<!-- notion-page-id: ${result.id} -->\nüîó Notion task created for this PR`
              });
            } catch (error) {
              console.error('‚ùå Failed to create Notion task:', error.message);
              core.setFailed(error.message);
            }
