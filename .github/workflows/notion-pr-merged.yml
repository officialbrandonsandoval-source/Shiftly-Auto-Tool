name: Update Notion Task on PR Merge

on:
  pull_request:
    types: [closed]

jobs:
  update-notion-task:
    runs-on: ubuntu-latest
    # Only run if PR was actually merged (not just closed)
    if: github.event.pull_request.merged == true
    steps:
      - name: Update Notion Task Status
        uses: actions/github-script@v7
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const notionApiKey = process.env.NOTION_API_KEY;
            const notionDatabaseId = process.env.NOTION_DATABASE_ID;
            
            if (!notionApiKey || !notionDatabaseId) {
              console.log('⚠️  Notion API credentials not configured. Skipping Notion task update.');
              console.log('To enable Notion integration, add NOTION_API_KEY and NOTION_DATABASE_ID secrets to your repository.');
              return;
            }
            
            // Get all comments to find the Notion page ID
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            let notionPageId = null;
            for (const comment of comments.data) {
              const match = comment.body.match(/<!-- notion-page-id: ([a-f0-9-]+) -->/);
              if (match) {
                notionPageId = match[1];
                break;
              }
            }
            
            if (!notionPageId) {
              console.log('⚠️  No Notion page ID found in PR comments. Task may have been created before this integration was set up.');
              
              // Try to find the task by PR number in Notion database
              try {
                const searchResponse = await fetch(`https://api.notion.com/v1/databases/${notionDatabaseId}/query`, {
                  method: 'POST',
                  headers: {
                    'Authorization': `Bearer ${notionApiKey}`,
                    'Content-Type': 'application/json',
                    'Notion-Version': '2022-06-28'
                  },
                  body: JSON.stringify({
                    filter: {
                      property: 'PR Number',
                      number: {
                        equals: prNumber
                      }
                    }
                  })
                });
                
                if (searchResponse.ok) {
                  const searchResult = await searchResponse.json();
                  if (searchResult.results.length > 0) {
                    notionPageId = searchResult.results[0].id;
                    console.log(`Found Notion task by PR number: ${notionPageId}`);
                  }
                }
              } catch (error) {
                console.error('Error searching for Notion task:', error.message);
              }
              
              if (!notionPageId) {
                console.log('Could not find Notion task to update.');
                return;
              }
            }
            
            // Update the Notion page status to Done
            try {
              const response = await fetch(`https://api.notion.com/v1/pages/${notionPageId}`, {
                method: 'PATCH',
                headers: {
                  'Authorization': `Bearer ${notionApiKey}`,
                  'Content-Type': 'application/json',
                  'Notion-Version': '2022-06-28'
                },
                body: JSON.stringify({
                  properties: {
                    Status: {
                      status: {
                        name: "Done"
                      }
                    }
                  }
                })
              });
              
              if (!response.ok) {
                const error = await response.text();
                throw new Error(`Notion API error: ${response.status} - ${error}`);
              }
              
              const result = await response.json();
              console.log('✅ Successfully updated Notion task status to Done');
              
              // Add a comment to the PR
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: '✅ Notion task status updated to Done'
              });
            } catch (error) {
              console.error('❌ Failed to update Notion task:', error.message);
              core.setFailed(error.message);
            }
